#!/usr/bin/env bash
# This script parses Apache logs and groups visitors by IP and HTTP status code

log_file="apache-access.log"

# Check if the log file exists
if [[ ! -f $log_file ]]; then
    echo "The log file is missing."
    exit 1
fi

# Check if the log file is empty
if [[ ! -s $log_file ]]; then
    echo "The log file is empty."
    exit 1
fi

# Check if the log file is in the expected format
# Assume a valid log entry has at least 9 fields
awk '
    BEGIN {
        wrong_format = 0;
        total_lines = 0;
    }
    {
        total_lines++;
        if (NF < 9) {
            wrong_format = 1;
        }
    }
    END {
        if (wrong_format) {
            print "The log file is in the wrong format.";
            exit;
        }
        if (total_lines == 0) {
            print "The log file is empty.";
            exit;
        }
    }
' "$log_file"

# Parse the log file and group by IP and HTTP status code using awk
awk '
    {
        # Increment the count for each IP and HTTP code combination
        count[$1, $9]++;
    }
    END {
        # Output the occurrences in the required format
        for (i in count) {
            split(i, parts, SUBSEP);
            print count[i], parts[1], parts[2];
        }
    }
' "$log_file" | sort -nr
