#!/usr/bin/env bash
# This script parses Apache logs and groups visitors by IP and HTTP status code

log_file="apache-access.log"

# Check if the log file exists
if [[ ! -f $log_file ]]; then
    echo "The log file is missing."
    exit 1
fi

# Check if the log file is empty
if [[ ! -s $log_file ]]; then
    echo "The log file is empty."
    exit 1
fi

# Check if the log file is in the expected format
# Expecting at least 9 fields for a valid log entry
if ! awk 'NF < 9 {print "The log file is in the wrong format."; exit 1}' "$log_file"; then
    echo "The log file is in the wrong format."
    exit 1
fi

# Parse the log file and group by IP and HTTP status code
awk '{print $1, $9}' "$log_file" | awk '{count[$1, $2]++} END {for (i in count) print count[i], i}' | sort -nr
