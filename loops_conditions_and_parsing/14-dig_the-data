#!/usr/bin/env bash
# This script parses an Apache log file, groups by IP and HTTP status code, and sorts by occurrences

LOG_FILE="apache-access.log"

# Check if the log file exists
if [ ! -f "$LOG_FILE" ]; then
    echo "The log file is missing."
    exit 1
fi

# Check if the log file is empty
if [ ! -s "$LOG_FILE" ]; then
    echo "The log file is empty."
    exit 0
fi

# Check if the log file has a correct format
if ! awk 'NR==1 {exit ($0 !~ /^[^ ]+ [^ ]+ [^ ]+$/)}' "$LOG_FILE"; then
    echo "The log file is in the wrong format."
    exit 1
fi

# Use awk to extract and group data, then sort by the number of occurrences
awk '{if ($9 ~ /^[0-9]{3}$/) print $1, $9}' "$LOG_FILE" | sort | uniq -c | sort -nr
